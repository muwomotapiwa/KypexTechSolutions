<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://www.googletagmanager.com https://www.google-analytics.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https://api.web3forms.com https://www.google-analytics.com; form-action https://api.web3forms.com; frame-src 'self' https://api.web3forms.com; frame-ancestors 'none'; base-uri 'self'; upgrade-insecure-requests">
    <meta name="referrer" content="strict-origin-when-cross-origin">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thank You | KypexTech</title>
    <link rel="stylesheet" href="css/style.css"> <!-- Shared CSS -->
    <link rel="stylesheet" href="css/thank-you.css"> <!-- Page-Specific CSS -->
</head>
<body class="thankyou-page">
    <!-- Header -->
    <header>
        <div class="logo">KypexTech</div>
        <nav>
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="index.html#services">Services</a></li>
                <li><a href="portfolio.html">Portfolio</a></li>
                <li><a href="about.html">About</a></li>
                <li><a href="contact.html">Contact</a></li>
            </ul>
        </nav>
        <div class="menu-icon" id="menuIcon"></div>
        <div class="mobile-nav" id="mobileNav">
            <a href="index.html">Home</a>
            <a href="index.html#services">Services</a>
            <a href="portfolio.html">Portfolio</a>
            <a href="about.html">About</a>
            <a href="contact.html">Contact</a>
        </div>
    </header>

    <!-- Thank You Section -->
    <section class="thankyou">
        <h1 id="thankTitle">Thank you!</h1>
        <p id="thankMessage">We’ve received your submission. Our team will contact you shortly.</p>
        <div id="calendarActions" style="display:none; margin-top:16px;">
            <p style="margin-bottom:12px;">Add your consultation to your calendar:</p>
            <a id="gcalLink" class="cta-button" target="_blank" rel="noopener">Add to Google Calendar</a>
            <a id="outlookLink" class="cta-button" target="_blank" rel="noopener">Open in Outlook</a>
            <a id="icsDownload" class="cta-button" download="kypextech-consultation.ics">Download .ics</a>
        </div>
        <a class="cta-button" href="index.html">Back to Home</a>
    </section>

    <!-- Footer -->
    <footer class="site-footer">
        <section class="footer-newsletter" aria-label="Newsletter">
            <h3>Subscribe to our newsletter</h3>
            <form class="newsletter-form" action="https://api.web3forms.com/submit" method="POST">
                <input type="hidden" name="access_key" value="af31cdca-fdb5-4fd7-81bd-762838f8e47f">
                <input type="hidden" name="subject" value="Newsletter Signup - KypexTech">
                <input type="hidden" name="page" value="thank-you.html">
                <input type="hidden" name="form" value="Newsletter">
                <input type="hidden" name="redirect" value="https://www.kypextech.co.za/thank-you.html">
                <label for="newsletter-email-ty" class="sr-only">Email address</label>
                <input id="newsletter-email-ty" type="email" name="email" placeholder="e.g. john@doe.com" required>
                <button type="submit" class="btn-subscribe">Subscribe now</button>
            </form>
            <p class="note">Get the latest to your inbox monthly. No spam — ever.</p>
        </section>
        <hr class="footer-sep">
        <section class="footer-columns">
            <div class="footer-brand col">
                <div class="footer-logo">KypexTech</div>
                <p>Modern IT solutions crafted with care. Juicy tech you will love.</p>
            </div>
            <nav class="col" aria-label="Company">
                <h4>Company</h4>
                <ul class="footer-list">
                    <li><a href="about.html">About us</a></li>
                    <li><a href="portfolio.html">Portfolio</a></li>
                    <li><a href="contact.html">Contact</a></li>
                </ul>
            </nav>
            <nav class="col" aria-label="Services">
                <h4>Services</h4>
                <ul class="footer-list">
                    <li><a href="website-development.html">Website Development</a></li>
                    <li><a href="mobile-app-development.html">Mobile Apps</a></li>
                    <li><a href="cybersecurity.html">Cybersecurity</a></li>
                    <li><a href="cloud-services.html">Cloud Services</a></li>
                    <li><a href="it-consulting.html">IT Consulting</a></li>
                    <li><a href="data-analytics.html">Data Analytics</a></li>
                </ul>
            </nav>
            <nav class="col" aria-label="Resources">
                <h4>Resources</h4>
                <ul class="footer-list">
                    <li><a href="assessment.html">Free Security Assessment</a></li>
                    <li><a href="consultation.html">Free Consultation</a></li>
                </ul>
                <div class="social-row" aria-label="Social links">
                    <a href="#" class="social-btn" aria-label="X">x</a>
                    <a href="#" class="social-btn" aria-label="Facebook">f</a>
                    <a href="#" class="social-btn" aria-label="LinkedIn">in</a>
                    <a href="#" class="social-btn" aria-label="Instagram">ig</a>
                    <a href="#" class="social-btn" aria-label="YouTube">yt</a>
                </div>
            </nav>
        </section>
        <div class="footer-bottom">
            <p>&copy; 2024 KypexTech · A Subsidiary of MuwomoHoldings</p>
        </div>
    </footer>

    <script>
        (function () {
            const params = new URLSearchParams(window.location.search);
            // Try to get the name from URL first, then from localStorage
            const name = params.get('name') || params.get('contactName') || sessionStorage.getItem('lastSubmitName') || '';
            // Prefer explicit form label, else subject, else derived from page
            const formLabel = params.get('form') || sessionStorage.getItem('lastSubmitForm') || params.get('subject') || '';
            const page = params.get('page') || sessionStorage.getItem('lastSubmitPage') || '';

            const nicePage = page ? page.replace('.html','').replace(/[-_]/g,' ').replace(/\b\w/g, c => c.toUpperCase()) : '';

            const title = document.getElementById('thankTitle');
            const msg = document.getElementById('thankMessage');

            const safeName = name ? name.trim() : '';
            const what = formLabel || (nicePage ? `${nicePage} form` : 'form');

            if (safeName) {
                title.textContent = `Thank you, ${safeName}!`;
                msg.textContent = `We’ve received your ${what} submission. Our team will be in touch shortly.`;
            } else {
                title.textContent = 'Thank you!';
                msg.textContent = `We’ve received your ${what} submission. Our team will be in touch shortly.`;
            }

            // If this was a consultation request and we have scheduling fields, show calendar actions
            const isConsultation = (formLabel && /consultation/i.test(formLabel)) || /consultation\.html$/i.test(page || '');
            const date = sessionStorage.getItem('preferredDate');
            const time = sessionStorage.getItem('preferredTime');
            const tz = sessionStorage.getItem('preferredTimezone') || Intl.DateTimeFormat().resolvedOptions().timeZone;

            function toUTC(dateStr, timeStr) {
              // Interpret selected local date/time as in the user's current zone
              const local = new Date(`${dateStr}T${timeStr}:00`);
              return local;
            }
            function fmtGoogle(dt) {
              // YYYYMMDDTHHMMSSZ using UTC
              const y = dt.getUTCFullYear();
              const m = String(dt.getUTCMonth()+1).padStart(2,'0');
              const d = String(dt.getUTCDate()).padStart(2,'0');
              const hh = String(dt.getUTCHours()).padStart(2,'0');
              const mm = String(dt.getUTCMinutes()).padStart(2,'0');
              const ss = '00';
              return `${y}${m}${d}T${hh}${mm}${ss}Z`;
            }
            function icsEscape(s){return (s||'').replace(/\\/g,'\\\\').replace(/\n/g,'\\n').replace(/,/g,'\\,').replace(/;/g,'\\;');}

            if (isConsultation && date && time) {
              const startLocal = toUTC(date, time);
              const endLocal = new Date(startLocal.getTime() + 30*60000); // default 30 mins
              const titleText = 'Consultation with KypexTech';
              const details = `Requested by ${safeName || 'client'} via KypexTech.`;

              const gStart = fmtGoogle(startLocal);
              const gEnd = fmtGoogle(endLocal);
              const gcal = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(titleText)}&dates=${gStart}%2F${gEnd}&details=${encodeURIComponent(details)}&location=${encodeURIComponent('Online')}&ctz=${encodeURIComponent(tz)}`;
              const outlook = `https://outlook.live.com/calendar/0/deeplink/compose?subject=${encodeURIComponent(titleText)}&startdt=${encodeURIComponent(startLocal.toISOString())}&enddt=${encodeURIComponent(endLocal.toISOString())}&body=${encodeURIComponent(details)}&location=${encodeURIComponent('Online')}`;

              const ics = [
                'BEGIN:VCALENDAR',
                'VERSION:2.0',
                'PRODID:-//KypexTech//Consultation//EN',
                'CALSCALE:GREGORIAN',
                'METHOD:PUBLISH',
                'BEGIN:VEVENT',
                `UID:${Date.now()}@kypextech.co.za`,
                `DTSTAMP:${fmtGoogle(new Date())}`,
                `DTSTART:${fmtGoogle(startLocal)}`,
                `DTEND:${fmtGoogle(endLocal)}`,
                `SUMMARY:${icsEscape(titleText)}`,
                `DESCRIPTION:${icsEscape(details)}`,
                `LOCATION:${icsEscape('Online')}`,
                'END:VEVENT',
                'END:VCALENDAR'
              ].join('\r\n');

              const calEl = document.getElementById('calendarActions');
              const gEl = document.getElementById('gcalLink');
              const oEl = document.getElementById('outlookLink');
              const iEl = document.getElementById('icsDownload');
              if (gEl) gEl.href = gcal;
              if (oEl) oEl.href = outlook;
              if (iEl) {
                const blob = new Blob([ics], {type: 'text/calendar'});
                iEl.href = URL.createObjectURL(blob);
              }
              if (calEl) calEl.style.display = 'block';
            }

            // Clear stored data for privacy
            try {
              sessionStorage.removeItem('lastSubmitName');
              sessionStorage.removeItem('lastSubmitForm');
              sessionStorage.removeItem('lastSubmitPage');
              sessionStorage.removeItem('preferredDate');
              sessionStorage.removeItem('preferredTime');
              sessionStorage.removeItem('preferredTimezone');
            } catch (e) { /* ignore */ }
        })();
    </script>
    <script src="js/form-redirect.js"></script>
    <script src="js/script.js"></script>
</body>
</html>
